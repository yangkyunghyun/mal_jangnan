<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>말장난 쇼핑몰</title>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: black;
    color: red;
    text-align: center;
  }

  .container {
    padding: 40px 20px;
  }

  h1 {
    font-size: 48px;
    margin-bottom: 10px;
  }

  .horse {
    width: 160px;
    margin: 0 auto 24px;
  }

  button {
    padding: 12px 24px;
    font-size: 18px;
    cursor: pointer;
    border: none;
    background: red;
    color: black;
    border-radius: 8px;
  }

  #uploadSection {
    display: none;
    margin-top: 24px;
  }

  input {
    padding: 8px;
    font-size: 14px;
    margin: 6px 0;
  }

  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px;
    padding: 20px;
    max-width: 1100px;
    margin: 0 auto 40px;
  }

  .card {
    border: 2px solid red;
    border-radius: 10px;
    overflow: hidden;
    background: #080808;
  }

  .card img {
    width: 100%;
    display: block;
  }

  .meta {
    font-size: 12px;
    color: #ff9999;
    padding: 6px 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .delete-btn {
    background: black;
    color: red;
    border: 1px solid red;
    padding: 2px 6px;
    font-size: 11px;
    cursor: pointer;
  }

  .status {
    margin-top: 10px;
    font-size: 14px;
    min-height: 20px;
  }
</style>
</head>

<body>

<div class="container">
  <h1>말장난 쇼핑몰</h1>

  <!-- 말 SVG -->
<img src="horse.svg" class="horse" alt="말 일러스트">

  <button id="reportBtn">제보하기</button>

  <div id="uploadSection">
    <div>
      <input id="uploadPw" type="password" placeholder="제보 비밀번호">
    </div>
    <input id="fileInput" type="file" accept="image/*" disabled>
    <div class="status" id="status"></div>
  </div>
</div>

<div class="gallery" id="gallery"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  /* ================= 설정 ================= */
const SUPABASE_URL = "https://bluixwtwlyhuoztusehd.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_nzq8U1pVHpHvVCErqq358w_dzQilZf1";

  const UPLOAD_PASSWORD = "upload123";
  const ADMIN_PASSWORD  = "admin123";
  /* ======================================= */

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  const reportBtn = document.getElementById("reportBtn");
  const uploadSection = document.getElementById("uploadSection");
  const fileInput = document.getElementById("fileInput");
  const uploadPw = document.getElementById("uploadPw");
  const gallery = document.getElementById("gallery");
  const statusEl = document.getElementById("status");

  reportBtn.onclick = () => {
    uploadSection.style.display = "block";
    uploadSection.scrollIntoView({ behavior: "smooth" });
  };

  uploadPw.oninput = () => {
    fileInput.disabled = uploadPw.value !== UPLOAD_PASSWORD;
  };

  function setStatus(msg, error=false) {
    statusEl.textContent = msg;
    statusEl.style.color = error ? "#ffaaaa" : "#aaffaa";
  }

  function formatDate(d) {
    return new Date(d).toLocaleString();
  }

  async function uploadImage(file) {
    const ext = file.name.split(".").pop();
    const name = crypto.randomUUID() + "." + ext;
    const path = "public/" + name;

    const { error: upErr } = await supabase
      .storage.from("photos")
      .upload(path, file);

    if (upErr) throw upErr;

    const { error: dbErr } = await supabase
      .from("photos")
      .insert({ path });

    if (dbErr) throw dbErr;
  }

  async function deleteImage(path) {
    const pw = prompt("관리자 비밀번호를 입력하세요");
    if (pw !== ADMIN_PASSWORD) {
      alert("비밀번호가 틀렸습니다");
      return;
    }

    await supabase.storage.from("photos").remove([path]);
    await supabase.from("photos").delete().eq("path", path);
    loadGallery();
  }

  async function loadGallery() {
    const { data } = await supabase
      .from("photos")
      .select("*")
      .order("created_at", { ascending: false });

    gallery.innerHTML = "";

    for (const row of data) {
      const { data: pub } = supabase
        .storage.from("photos")
        .getPublicUrl(row.path);

      const card = document.createElement("div");
      card.className = "card";

      const img = document.createElement("img");
      img.src = pub.publicUrl;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <span>${formatDate(row.created_at)}</span>
        <button class="delete-btn">삭제</button>
      `;

      meta.querySelector("button").onclick = () => deleteImage(row.path);

      card.appendChild(img);
      card.appendChild(meta);
      gallery.appendChild(card);
    }
  }

  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      setStatus("업로드 중...");
      await uploadImage(file);
      setStatus("업로드 완료!");
      loadGallery();
    } catch (err) {
      setStatus("업로드 실패", true);
    }
    fileInput.value = "";
  };

  loadGallery();
</script>

</body>
</html>
